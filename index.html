<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="favicon-small.png">
    <title>Tetris Classic by Martijn Luyckx</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .game {
            position: relative;
            display: flex;
            flex-direction: column;
            --cell-border: 1px solid #ddd;
            --field-width: 10;
            --field-height: 20;
            --cell-size: 20px;
        }
        .game.paused > * {
            opacity: 0.3;
        }
        .game.game-over .field {
            opacity: 0.3;
        }
        .game.paused::before, .game.paused::after {
            content: '';
            position: absolute;
            height: 80px;
            width: 30px;
            background: black;
            top: 200px;
            left: 66px;
            opacity: 1 !important;
            z-index: 2;
        }
        .game.paused::after {
            left: 106px;
        }
        .game.game-over::before, .game.game-over::after {
            content: 'Game Over';
            font-family: sans-serif;
            font-size: 22px;
            text-align: center;
            position: absolute;
            width: 150px;
            top: 200px;
            left: 26px;
            font-weight: bold;
            opacity: 1 !important;
            z-index: 2;
        }
        .game.game-over::after {
            content: "Press R or tap the screen to continue";
            font-weight: normal;
            font-size: 12px;
            top: 230px;
        }
        .game .score, .game .level {
            text-align: center;
            margin-bottom: 5px;
        }
        .game .level {
            margin-bottom: -2px;
        }
        .game .score #score, .game .level #level {
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }
        .game .field {
            user-select: none;
            width: calc(var(--cell-size) * var(--field-width));
            height: calc(var(--cell-size) * var(--field-height));
            display: flex;
            flex-direction: column-reverse;
        }
        .game .field .row {
            display: flex;
        }
        .game .field .row .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-left: var(--cell-border);
            border-bottom: var(--cell-border);
        }
        .game .field .row:last-child {
            border-top: var(--cell-border);
        }
        .game .field .row .cell:last-child {
            border-right: var(--cell-border);
        }
    </style>
    <script>
        const game_over_audio = new Audio('sound_effects/game_over.mp3');
        const place_piece_audio = new Audio('sound_effects/place_piece.mp3');
        const clear_line_audio = [
            new Audio('sound_effects/clear_line.mp3'),
            new Audio('sound_effects/clear_2_lines.mp3'),
            new Audio('sound_effects/clear_3_lines.mp3'),
            new Audio('sound_effects/clear_4_lines.mp3'),
        ];
        const topBuffer = 2;
        const rows = 20;
        const columns = 10;
        const maxLevel = 9;
        const linesPerLevel = 10;
        let holdingSoftDrop = false;
        let gameloop = undefined;
        let zoomLevel = 1;
        let combo = 0;
        let backToBack = false;
        let level = 1;
        let pause = false;
        let gameOver = false;
        let canRestart = true;
        let canRestartTimeout = undefined;
        let currentPiece = "";
        let linesCleared = 0;
        let score = 0;
        let softDropBuffer = 0;
        let rowElems = undefined;
        let levelElem = undefined;
        let scoreElem = undefined;
        let gameElem = undefined;
        let pieces = [
            {
                name: "I",
                colour: "#71cff5",
                shape: ["0000", "2314"],
            },
            {
                name: "T",
                colour: "#f571d6",
                shape: ["0020", "0314"],
            },
            {
                name: "O",
                colour: "#eef571",
                shape: ["0230", "0410"],
            },
            {
                name: "Z",
                colour: "#7cf571",
                shape: ["0023", "0410"],
            },
            {
                name: "S",
                colour: "#f57171",
                shape: ["0230", "0014"],
            },
            {
                name: "L",
                colour: "#f5a871",
                shape: ["0004", "0213"],
            },
            {
                name: "J",
                colour: "#cb71f5",
                shape: ["0400", "0213"],
            },
        ];
        let field = [];
        function resizeGame() {
            const viewWidth = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
            const viewHeight = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
            if (!gameElem) gameElem = document.getElementById("game");
            const gameWidth = gameElem.offsetWidth;
            const gameHeight = gameElem.offsetHeight;
            gameElem.style.transform = `scale(${zoomLevel * Math.min(viewWidth/(gameWidth+20), viewHeight/(gameHeight+20))})`;
        }
        function randomId() {
            return Math.random().toString(36).substr(2, 9);
        };
        function updateField() {
            if (!rowElems) {
                rowElems = document.getElementsByClassName("row");
            }
            for (let row = 0; row < rows; row++) {
                for (let column = 0; column < columns; column++) {
                    cell = field[row][column];
                    rowElems[row].children[column].style.background = cell.colour ? cell.colour : "white";
                }
            }
        }
        function deepCopy(obj) {
            return JSON.parse(JSON.stringify(obj));
        }
        function getPieceObject(name) {
            id = randomId();
            for (let piece of pieces) {
                if (piece.name === name) {
                    copy = deepCopy(piece);
                    copy.rotation = 0;
                    copy.state = "moving";
                    copy.id = id;
                    return copy;
                }
            }
            return {};
        }
        function getCellsOfPiece(id) {
            cellsOfPiece = [];
            for (let row = 0; row < rows + topBuffer; row++) {
                for (let column = 0; column < columns; column++) {
                    if(field[row][column].id === id) {
                        cellsOfPiece.push([row, column]);
                    }
                }
            }
            return cellsOfPiece;
        }
        function noMovingPieces() {
            for (let row = 0; row < rows + topBuffer; row++) {
                for (let column = 0; column < columns; column++) {
                    if(field[row][column].state === 'moving') {
                        return false;
                    }
                    
                }
            }
            return true;
        }
        function moveDownAbove(floor) {
            if (pause) return;
            for (let row = floor+1; row < rows + topBuffer; row++) {
                for (let column = 0; column < columns; column++) {
                    field[row-1][column] = field[row][column];
                }
            }
        }
        function updateScoreField() {
            if (!levelElem) levelElem = document.getElementById("level");
            if (!scoreElem) scoreElem = document.getElementById("score");
            scoreElem.innerText = score;
            levelElem.innerText = level;
        }
        function addDropScore() {
            score += softDropBuffer;
            softDropBuffer = 0;
            updateScoreField();
        }
        function addScoreForLines(lines) {
            if (lines <= 0 || lines > 4) return;
            if (lines === undefined) {
                linesCleared = 0;
                score = 0;
                level = 1;
                setGameLoop();
            }
            else {
                const prevBackToBack = backToBack;
                backToBack = lines === 4;
                linesCleared += lines;
                let scored = ([100, 300, 500, 800][lines-1]*level) + (50 * combo * level);
                if (combo > 0) {
                    console.log("Combo!");
                }
                if (backToBack && prevBackToBack) {
                    console.log("Back-to-back!");
                    scored *= 1.5;
                }
                score += scored;
                const prevLevel = level;
                level = Math.min(Math.floor(linesCleared/linesPerLevel+1), maxLevel);
                if (prevLevel !== level) {
                    setGameLoop();
                }
            }
            updateScoreField();
        }
        function removeFullLines() {
            if (pause) return;
            let lines = getFullLines();
            addScoreForLines(lines.length);
            if (!!lines.length) combo += 1;
            else combo = 0;
            if (lines.length > 0) {
                clear_line_audio[Math.min(combo, 3)].pause();
                clear_line_audio[Math.min(combo, 3)].currentTime = 0;
                clear_line_audio[Math.min(combo, 3)].play();
            }
            while (lines.length > 0) {
                moveDownAbove(lines[0]);
                lines = getFullLines();
            }
            return !!lines;
        }
        function isGameOver() {
            for (let row = rows + 1; row < rows + topBuffer; row++) {
                for (let column = 0; column < columns; column++) {
                    if(field[row][column].state === 'solid') {
                        return true;
                    }
                }
            }
            return false;
        }
        function getFullLines() {
            fullLines = [];
            for (let row = 0; row < rows + topBuffer; row++) {
                let full = true;
                for (let column = 0; column < columns; column++) {
                    if(field[row][column].state !== 'solid') {
                        full = false;
                        break
                    }
                }
                if (full) fullLines.push(row);
            }
            return fullLines;
        }
        function insertRandomPiece() {
            if (pause) return;
            insertPiece(pieces[Math.floor(Math.random() * pieces.length)].name);
            advancePiece(currentPiece, "down");
        }
        function restartGame(userWantsToRestartGame) {
            if (!userWantsToRestartGame && !pause) {
                game_over_audio.pause();
                game_over_audio.currentTime = 0;
                game_over_audio.play();
            }
            first_game = currentPiece === "";
            if (!first_game) {
                pause = true;
                if (!gameElem) gameElem = document.getElementById("game");
                gameElem.classList.add("game-over");
            }
            currentPiece = "";
            if (userWantsToRestartGame) {
                if (!canRestart) return;
                gameOver = false;
                pause = false;
                gameElem.classList.remove("game-over");
                gameElem.classList.remove("paused");
                field = [];
                for (let i = 0; i < rows + topBuffer; i++) {
                    field.push([]);
                    for (let j = 0; j < columns; j++) {
                        field[i].push({});
                    }
                }
                addScoreForLines(); // no argument = reset
                insertRandomPiece();
            }
        }
        function advancePiece(id, direction) {
            if (pause) return;
            let solidSoundPlayed = false;
            let rotationDirection = 1;
            if (direction === 'rrotate') {
                rotationDirection = -1;
                direction = 'rotate';
            }
            const cells = getCellsOfPiece(id);
            const willMove = pieceCanMove(direction, cells, id, rotationDirection);
            if (!willMove) {
                if (direction === 'down') {
                    for (let coords of cells) {
                        field[coords[0]][coords[1]].state = 'solid';
                        if (!solidSoundPlayed) {
                            solidSoundPlayed = true;
                            place_piece_audio.pause();
                            place_piece_audio.currentTime = 0;
                            place_piece_audio.play();
                        }
                    }
                    addDropScore();
                    if (gameOver = isGameOver()) {
                        canRestart = false;
                        if (!canRestartTimeout) {
                            canRestartTimeout = setTimeout(function() {
                                canRestart = true;
                                clearTimeout(canRestartTimeout);
                                canRestartTimeout = undefined;
                            }, 1000);
                        }
                        restartGame();
                    }
                    else {
                        removeFullLines();
                        insertRandomPiece();
                    }
                }
            } else {
                if (direction !== "right" && direction !== "rotate") {
                    for (let coords of cells) {
                        let newRow = coords[0];
                        let newColumn = coords[1];
                        if (direction === 'down') newRow -= 1;
                        if (direction === 'left') newColumn -= 1;
                        field[newRow][newColumn] = field[coords[0]][coords[1]];
                        field[coords[0]][coords[1]] = {};
                    }
                } else if (direction === "right") {
                    for (let i = cells.length-1; i >= 0; i--) {
                        const coords = cells[i];
                        let newRow = coords[0];
                        let newColumn = coords[1] + 1;
                        field[newRow][newColumn] = field[coords[0]][coords[1]];
                        field[coords[0]][coords[1]] = {};
                    }
                } else if (direction === "rotate") {
                    rotatePiece(cells, rotationDirection);
                }
            }
            updateField();
        }
        function pieceCanMove(direction, cellsOfPiece, id, rotationDirection=0) {
            if (direction === "rotate") return pieceCanRotate(cellsOfPiece, rotationDirection);
            if (cellsOfPiece.length <= 0 || cellsOfPiece[0].state === 'solid') return false;
            for (let coords of cellsOfPiece) {
                let newRow = coords[0];
                let newColumn = coords[1];
                if (direction === 'down') newRow -= 1;
                if (direction === 'left') newColumn -= 1;
                if (direction === 'right') newColumn += 1;
                if (newRow < 0) return false;
                if (newColumn < 0 || newColumn >= columns) return false;
                else {

                    const neighbour = field[newRow][newColumn];
                    if (neighbour.name && neighbour.state === 'solid') return false;
                }
            }
            return true;
        }
        function insertPiece(name, rotation=0, id="", center=[]) {
            if (pause) return;
            if (!noMovingPieces()) return;
            piece = getPieceObject(name);
            piece.rotation = rotation;
            if (id && id.length > 0) piece.id = id;
            currentPiece = piece.id;
            // Default (standard rotation at the top of the screen)
            if (rotation === 0 && (!center || center.length <= 0)) {
                field[rows+1][3] = piece.shape[0][0] === '0'? {} : deepCopy(piece);
                field[rows+1][3].piecePart = piece.shape[0][0];
                field[rows+1][4] = piece.shape[0][1] === '0'? {} : deepCopy(piece);
                field[rows+1][4].piecePart = piece.shape[0][1];
                field[rows+1][5] = piece.shape[0][2] === '0'? {} : deepCopy(piece);
                field[rows+1][5].piecePart = piece.shape[0][2];
                field[rows+1][6] = piece.shape[0][3] === '0'? {} : deepCopy(piece);
                field[rows+1][6].piecePart = piece.shape[0][3];
                field[rows][3] = piece.shape[1][0] === '0'? {} : deepCopy(piece);
                field[rows][3].piecePart = piece.shape[1][0];
                field[rows][4] = piece.shape[1][1] === '0'? {} : deepCopy(piece);
                field[rows][4].piecePart = piece.shape[1][1];
                field[rows][5] = piece.shape[1][2] === '0'? {} : deepCopy(piece);
                field[rows][5].piecePart = piece.shape[1][2];
                field[rows][6] = piece.shape[1][3] === '0'? {} : deepCopy(piece);
                field[rows][6].piecePart = piece.shape[1][3];
            }
            else {
                if (rotation === 0 || piece.name === "O") insertPieceDownwards(piece, center);
                else if (rotation === 1) insertPieceLeft(piece, center);
                else if (rotation === 2) insertPieceUpwards(piece, center);
                else if (rotation === 3) insertPieceRight(piece, center);
            }
        }
        function insertPieceLeft(piece, center) {
            if (pause) return;
            if (piece.shape[0][0] !== '0') {
                field[center[0]+2][center[1]+1] = piece.shape[0][0] === '0'? field[center[0]+2][center[1]+1] : deepCopy(piece);
                field[center[0]+2][center[1]+1].piecePart = piece.shape[0][0];
            }
            if (piece.shape[0][1] !== '0') {
                field[center[0]+1][center[1]+1] = piece.shape[0][1] === '0'? field[center[0]+1][center[1]+1] : deepCopy(piece);
                field[center[0]+1][center[1]+1].piecePart = piece.shape[0][1];
            }
            if (piece.shape[0][2] !== '0') {
                field[center[0]][center[1]+1] = piece.shape[0][2] === '0'? field[center[0]][center[1]+1] : deepCopy(piece);
                field[center[0]][center[1]+1].piecePart = piece.shape[0][2];
            }
            if (piece.shape[0][3] !== '0') {
                field[center[0]-1][center[1]+1] = piece.shape[0][3] === '0'? field[center[0]-1][center[1]+1] : deepCopy(piece);
                field[center[0]-1][center[1]+1].piecePart = piece.shape[0][3];
            }

            if (piece.shape[1][0] !== '0') {
                field[center[0]+2][center[1]] = piece.shape[1][0] === '0'? field[center[0]+2][center[1]] : deepCopy(piece);
                field[center[0]+2][center[1]].piecePart = piece.shape[1][0];
            }
            if (piece.shape[1][1] !== '0') {
                field[center[0]+1][center[1]] = piece.shape[1][1] === '0'? field[center[0]+1][center[1]] : deepCopy(piece);
                field[center[0]+1][center[1]].piecePart = piece.shape[1][1];
            }
            if (piece.shape[1][2] !== '0') {
                field[center[0]][center[1]] = piece.shape[1][2] === '0'? field[center[0]][center[1]] : deepCopy(piece);
                field[center[0]][center[1]].piecePart = piece.shape[1][2];
            }
            if (piece.shape[1][3] !== '0') {
                field[center[0]-1][center[1]] = piece.shape[1][3] === '0'? field[center[0]-1][center[1]] : deepCopy(piece);
                field[center[0]-1][center[1]].piecePart = piece.shape[1][3];
            }
        }  
        function insertPieceUpwards(piece, center) {
            if (pause) return;
            if (piece.shape[0][0] !== '0') {
                field[center[0]-1][center[1]+2] = piece.shape[0][0] === '0'? field[center[0]-1][center[1]+2] : deepCopy(piece);
                field[center[0]-1][center[1]+2].piecePart = piece.shape[0][0];
            }
            if (piece.shape[0][1] !== '0') {
                field[center[0]-1][center[1]+1] = piece.shape[0][1] === '0'? field[center[0]-1][center[1]+1] : deepCopy(piece);
                field[center[0]-1][center[1]+1].piecePart = piece.shape[0][1];
            }
            if (piece.shape[0][2] !== '0') {
                field[center[0]-1][center[1]] = piece.shape[0][2] === '0'? field[center[0]-1][center[1]] : deepCopy(piece);
                field[center[0]-1][center[1]].piecePart = piece.shape[0][2];
            }
            if (piece.shape[0][3] !== '0') {
                field[center[0]-1][center[1]-1] = piece.shape[0][3] === '0'? field[center[0]-1][center[1]-1] : deepCopy(piece);
                field[center[0]-1][center[1]-1].piecePart = piece.shape[0][3];
            }

            if (piece.shape[1][0] !== '0') {
                field[center[0]][center[1]+2] = piece.shape[1][0] === '0'? field[center[0]][center[1]+2] : deepCopy(piece);
                field[center[0]][center[1]+2].piecePart = piece.shape[1][0];
            }
            if (piece.shape[1][1] !== '0') {
                field[center[0]][center[1]+1] = piece.shape[1][1] === '0'? field[center[0]][center[1]+1] : deepCopy(piece);
                field[center[0]][center[1]+1].piecePart = piece.shape[1][1];
            }
            if (piece.shape[1][2] !== '0') {
                field[center[0]][center[1]] = piece.shape[1][2] === '0'? field[center[0]][center[1]] : deepCopy(piece);
                field[center[0]][center[1]].piecePart = piece.shape[1][2];
            }
            if (piece.shape[1][3] !== '0') {
                field[center[0]][center[1]-1] = piece.shape[1][3] === '0'? field[center[0]][center[1]-1] : deepCopy(piece);
                field[center[0]][center[1]-1].piecePart = piece.shape[1][3];
            }
        }

        function insertPieceRight(piece, center) {
            if (pause) return;
            if (piece.shape[0][0] !== '0') {
                field[center[0]-2][center[1]-1] = piece.shape[0][0] === '0'? field[center[0]-2][center[1]-1] : deepCopy(piece);
                field[center[0]-2][center[1]-1].piecePart = piece.shape[0][0];
            }
            if (piece.shape[0][1] !== '0') {
                field[center[0]-1][center[1]-1] = piece.shape[0][1] === '0'? field[center[0]-1][center[1]-1] : deepCopy(piece);
                field[center[0]-1][center[1]-1].piecePart = piece.shape[0][1];
            }
            if (piece.shape[0][2] !== '0') {
                field[center[0]][center[1]-1] = piece.shape[0][2] === '0'? field[center[0]][center[1]-1] : deepCopy(piece);
                field[center[0]][center[1]-1].piecePart = piece.shape[0][2];
            }
            if (piece.shape[0][3] !== '0') {
                field[center[0]+1][center[1]-1] = piece.shape[0][3] === '0'? field[center[0]+1][center[1]-1] : deepCopy(piece);
                field[center[0]+1][center[1]-1].piecePart = piece.shape[0][3];
            }

            if (piece.shape[1][0] !== '0') {
                field[center[0]-2][center[1]] = piece.shape[1][0] === '0'? field[center[0]-2][center[1]] : deepCopy(piece);
                field[center[0]-2][center[1]].piecePart = piece.shape[1][0];
            }
            if (piece.shape[1][1] !== '0') {
                field[center[0]-1][center[1]] = piece.shape[1][1] === '0'? field[center[0]-1][center[1]] : deepCopy(piece);
                field[center[0]-1][center[1]].piecePart = piece.shape[1][1];
            }
            if (piece.shape[1][2] !== '0') {
                field[center[0]][center[1]] = piece.shape[1][2] === '0'? field[center[0]][center[1]] : deepCopy(piece);
                field[center[0]][center[1]].piecePart = piece.shape[1][2];
            }
            if (piece.shape[1][3] !== '0') {
                field[center[0]+1][center[1]] = piece.shape[1][3] === '0'? field[center[0]+1][center[1]] : deepCopy(piece);
                field[center[0]+1][center[1]].piecePart = piece.shape[1][3];
            }
        }
        function insertPieceDownwards(piece, center) {
            if (pause) return;
            if (piece.shape[0][0] !== '0') {
                field[center[0]+1][center[1]-2] = piece.shape[0][0] === '0'? field[center[0]+1][center[1]-2] : deepCopy(piece);
                field[center[0]+1][center[1]-2].piecePart = piece.shape[0][0];
            }
            if (piece.shape[0][1] !== '0') {
                field[center[0]+1][center[1]-1] = piece.shape[0][1] === '0'? field[center[0]+1][center[1]-1] : deepCopy(piece);
                field[center[0]+1][center[1]-1].piecePart = piece.shape[0][1];
            }
            if (piece.shape[0][2] !== '0') {
                field[center[0]+1][center[1]] = piece.shape[0][2] === '0'? field[center[0]+1][center[1]] : deepCopy(piece);
                field[center[0]+1][center[1]].piecePart = piece.shape[0][2];
            }
            if (piece.shape[0][3] !== '0') {
                field[center[0]+1][center[1]+1] = piece.shape[0][3] === '0'? field[center[0]+1][center[1]+1] : deepCopy(piece);
                field[center[0]+1][center[1]+1].piecePart = piece.shape[0][3];
            }

            if (piece.shape[1][0] !== '0') {
                field[center[0]][center[1]-2] = piece.shape[1][0] === '0'? field[center[0]][center[1]-2] : deepCopy(piece);
                field[center[0]][center[1]-2].piecePart = piece.shape[1][0];
            }
            if (piece.shape[1][1] !== '0') {
                field[center[0]][center[1]-1] = piece.shape[1][1] === '0'? field[center[0]][center[1]-1] : deepCopy(piece);
                field[center[0]][center[1]-1].piecePart = piece.shape[1][1];
            }
            if (piece.shape[1][2] !== '0') {
                field[center[0]][center[1]] = piece.shape[1][2] === '0'? field[center[0]][center[1]] : deepCopy(piece);
                field[center[0]][center[1]].piecePart = piece.shape[1][2];
            }
            if (piece.shape[1][3] !== '0') {
                field[center[0]][center[1]+1] = piece.shape[1][3] === '0'? field[center[0]][center[1]+1] : deepCopy(piece);
                field[center[0]][center[1]+1].piecePart = piece.shape[1][3];
            }
        }
        function pieceCanRotate(cells, rotationDirection) {
            let center;
            let rotation;
            let pieceName;
            let id;
            for (coords of cells) {
                const cell = field[coords[0]][coords[1]];
                if (cell.piecePart === "1") {
                    id = cell.id;
                    center = coords;
                    pieceName = cell.name;
                    rotation = (cell.rotation + rotationDirection) % 4;
                    continue;
                }
            }
            piece = getPieceObject(pieceName);
            piece.rotation = rotation;
            if (id && id.length > 0) piece.id = id;
            currentPiece = piece.id;
            if (rotation === 1) {
                // left
                if (piece.shape[0][0] !== '0' && ((center[0]+2 < 0 || center[0]+2 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+2][center[1]+1].name !== undefined && field[center[0]+2][center[1]+1].id !== id))) return false;
                if (piece.shape[0][1] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+1][center[1]+1].name !== undefined && field[center[0]+1][center[1]+1].id !== id))) return false;
                if (piece.shape[0][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+0][center[1]+1].name !== undefined && field[center[0]+0][center[1]+1].id !== id))) return false;
                if (piece.shape[0][3] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]-1][center[1]+1].name !== undefined && field[center[0]-1][center[1]+1].id !== id))) return false;
                if (piece.shape[1][0] !== '0' && ((center[0]+2 < 0 || center[0]+2 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+2][center[1]+0].name !== undefined && field[center[0]+2][center[1]+0].id !== id))) return false;
                if (piece.shape[1][1] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+1][center[1]+0].name !== undefined && field[center[0]+1][center[1]+0].id !== id))) return false;
                if (piece.shape[1][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+0][center[1]+0].name !== undefined && field[center[0]+0][center[1]+0].id !== id))) return false;
                if (piece.shape[1][3] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]-1][center[1]+0].name !== undefined && field[center[0]-1][center[1]+0].id !== id))) return false;
                return true;
            }
            else if (rotation === 2) {
                // upwards
                if (piece.shape[0][0] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+2 < 0 || center[1]+2 >= columns) || (field[center[0]-1][center[1]+2].name !== undefined && field[center[0]-1][center[1]+2].id !== id))) return false;
                if (piece.shape[0][1] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]-1][center[1]+1].name !== undefined && field[center[0]-1][center[1]+1].id !== id))) return false;
                if (piece.shape[0][2] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]-1][center[1]+0].name !== undefined && field[center[0]-1][center[1]+0].id !== id))) return false;
                if (piece.shape[0][3] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]-1][center[1]-1].name !== undefined && field[center[0]-1][center[1]-1].id !== id))) return false;
                if (piece.shape[1][0] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+2 < 0 || center[1]+2 >= columns) || (field[center[0]+0][center[1]+2].name !== undefined && field[center[0]+0][center[1]+2].id !== id))) return false;
                if (piece.shape[1][1] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+0][center[1]+1].name !== undefined && field[center[0]+0][center[1]+1].id !== id))) return false;
                if (piece.shape[1][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+0][center[1]+0].name !== undefined && field[center[0]+0][center[1]+0].id !== id))) return false;
                if (piece.shape[1][3] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]+0][center[1]-1].name !== undefined && field[center[0]+0][center[1]-1].id !== id))) return false;
                return true;
            }
            else if (rotation === 3) {
                // right
                if (piece.shape[0][0] !== '0' && ((center[0]-2 < 0 || center[0]-2 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]-2][center[1]-1].name !== undefined && field[center[0]-2][center[1]-1].id !== id))) return false;
                if (piece.shape[0][1] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]-1][center[1]-1].name !== undefined && field[center[0]-1][center[1]-1].id !== id))) return false;
                if (piece.shape[0][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]+0][center[1]-1].name !== undefined && field[center[0]+0][center[1]-1].id !== id))) return false;
                if (piece.shape[0][3] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]+1][center[1]-1].name !== undefined && field[center[0]+1][center[1]-1].id !== id))) return false;
                if (piece.shape[1][0] !== '0' && ((center[0]-2 < 0 || center[0]-2 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]-2][center[1]+0].name !== undefined && field[center[0]-2][center[1]+0].id !== id))) return false;
                if (piece.shape[1][1] !== '0' && ((center[0]-1 < 0 || center[0]-1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]-1][center[1]+0].name !== undefined && field[center[0]-1][center[1]+0].id !== id))) return false;
                if (piece.shape[1][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+0][center[1]+0].name !== undefined && field[center[0]+0][center[1]+0].id !== id))) return false;
                if (piece.shape[1][3] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+1][center[1]+0].name !== undefined && field[center[0]+1][center[1]+0].id !== id))) return false;
                return true;
            }
            else if (rotation === 0) {
                // downwards
                if (piece.shape[0][0] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]-2 < 0 || center[1]-2 >= columns) || (field[center[0]+1][center[1]-2].name !== undefined && field[center[0]+1][center[1]-2].id !== id))) return false;
                if (piece.shape[0][1] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]+1][center[1]-1].name !== undefined && field[center[0]+1][center[1]-1].id !== id))) return false;
                if (piece.shape[0][2] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+1][center[1]+0].name !== undefined && field[center[0]+1][center[1]+0].id !== id))) return false;
                if (piece.shape[0][3] !== '0' && ((center[0]+1 < 0 || center[0]+1 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+1][center[1]+1].name !== undefined && field[center[0]+1][center[1]+1].id !== id))) return false;
                if (piece.shape[1][0] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]-2 < 0 || center[1]-2 >= columns) || (field[center[0]+0][center[1]-2].name !== undefined && field[center[0]+0][center[1]-2].id !== id))) return false;
                if (piece.shape[1][1] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]-1 < 0 || center[1]-1 >= columns) || (field[center[0]+0][center[1]-1].name !== undefined && field[center[0]+0][center[1]-1].id !== id))) return false;
                if (piece.shape[1][2] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+0 < 0 || center[1]+0 >= columns) || (field[center[0]+0][center[1]+0].name !== undefined && field[center[0]+0][center[1]+0].id !== id))) return false;
                if (piece.shape[1][3] !== '0' && ((center[0]+0 < 0 || center[0]+0 >= rows + topBuffer || center[1]+1 < 0 || center[1]+1 >= columns) || (field[center[0]+0][center[1]+1].name !== undefined && field[center[0]+0][center[1]+1].id !== id))) return false;
                return true;
            }
            return true; // not implemented
        }
        function rotatePiece(cells, rotationDirection=1) {
            if (pause) return;
            // Rotations: 0 = bottom, 1 = left, 2 = top, 3 = right
            let center;
            let rotation;
            let pieceName;
            let id;
            for (coords of cells) {
                const cell = field[coords[0]][coords[1]];
                field[coords[0]][coords[1]] = {};
                if (cell.piecePart === "1") {
                    id = cell.id;
                    center = coords;
                    pieceName = cell.name;
                    rotation = (cell.rotation + rotationDirection) % 4;
                    continue;
                }
            }
            insertPiece(pieceName, rotation, id, center)
        }
        function advanceField() {
            if (pause) return;
            let handledPieces = [];
            for (let row = 0; row < rows + topBuffer; row++) {
                for (let column = 0; column < columns; column++) {
                    cell = field[row][column];
                    if (cell.state === 'moving' && !handledPieces.includes(cell.id)) {
                        handledPieces.push(cell.id);
                        advancePiece(cell.id, "down");
                    }
                }
            }
            updateField();
        }
        function dropPiece(id) {
            if (pause) return;
            let cells;
            softDropBuffer = 0;
            do {
                softDropBuffer += 1;
                advancePiece(id, "down");
                cells = getCellsOfPiece(id);
                if (!cells || !cells[0]) break;
            } while (field[cells[0][0]][cells[0][1]].state === 'moving')
        }
        document.onkeyup = function(e) {
            if (e.key === 'ArrowDown') {
                holdingSoftDrop = false;
                softDropBuffer = 0;
            }
        }
        document.onkeydown = function(e) {
            e = e || window.event;
            if (e.key === 'R' || e.key === 'r') {
                if (gameOver && canRestart) restartGame(true);
                else if (pause) restartGame(true);
            }
            if (e.key === 'ArrowLeft') {
                advancePiece(currentPiece, "left"); updateField();
            } else if (e.key === 'ArrowRight') {
                advancePiece(currentPiece, "right"); updateField();
            } else if (e.key === 'ArrowDown') {
                softDropBuffer += 1;
                advancePiece(currentPiece, "down"); updateField();
            } else if (e.key === 'ArrowUp') {
                advancePiece(currentPiece, "rotate"); updateField();
            } else if (e.key === '-') {
                zoomLevel -= 0.1;
                zoomLevel = Math.max(0.1, zoomLevel);
                resizeGame();
            } else if (e.key === '+') {
                zoomLevel += 0.1;
                zoomLevel = Math.min(1.0, zoomLevel);
                resizeGame();
            } else if (e.key === '0') {
                advancePiece(currentPiece, "rrotate"); updateField();
            } else if (e.key === ' ') {
                dropPiece(currentPiece); updateField();
            } else if (e.key === 'Escape') {
                console.log("(Un)paused");
                pause = !pause;
                if (!gameElem) gameElem = document.getElementById("game");
                if (pause) gameElem.classList.add("paused");
                else gameElem.classList.remove("paused");
            }
        }
        document.addEventListener('touchstart', handleTouchStart, false);        
        document.addEventListener('touchmove', handleTouchMove, false);
        document.addEventListener('touchend', handleTouchEnd, false);
        document.addEventListener( "contextmenu", function(e) { e.preventDefault(); (currentPiece); updateField(); touchhandled = true;});
        window.addEventListener("resize", resizeGame);

        var xDown = null;                                                        
        var yDown = null;
        var touchstart = null;
        var touchhandled = false;

        function getTouches(evt) {
        return evt.touches ||             // browser API
                evt.originalEvent.touches; // jQuery
        }                                                     
        function handleTouchEnd(evt) {
            evt.preventDefault();
            const now = (new Date()).getTime();
            if (now - touchstart < 200 && !touchhandled) {
                touchhandled = true;
                advancePiece(currentPiece, "rotate"); updateField();
            }
            else if (now - touchstart >= 500 && !touchhandled) {
                touchhandled = true;
                dropPiece(currentPiece); updateField();
            }
        }
        function handleTouchStart(evt) {
            evt.preventDefault();
            if (gameOver) { 
                if (canRestart) restartGame(true);
                return;
            }
            touchhandled = false;
            touchstart = (new Date()).getTime();
            const firstTouch = getTouches(evt)[0];                                      
            xDown = firstTouch.clientX;                                      
            yDown = firstTouch.clientY;                                      
        };                                                

        function handleTouchMove(evt) {
            evt.preventDefault();
            if ( ! xDown || ! yDown ) {
                return;
            }

            var xUp = evt.touches[0].clientX;                                    
            var yUp = evt.touches[0].clientY;

            var xDiff = xDown - xUp;
            var yDiff = yDown - yUp;

            if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
                if ( xDiff > 0 ) {
                    advancePiece(currentPiece, "left"); updateField();
                    touchhandled = true;
                } else {
                    advancePiece(currentPiece, "right"); updateField();
                    touchhandled = true;
                }                       
            } else {
                if ( yDiff > 0 ) {
                    dropPiece(currentPiece); updateField();
                    touchhandled = true;
                } else { 
                    softDropBuffer += 1;
                    advancePiece(currentPiece, "down"); updateField();
                    touchhandled = true;
                }                                                                 
            }
            /* reset values */
            xDown = null;
            yDown = null;                                             
        };
        function setGameLoop() {
            if (gameloop) {
                clearInterval(gameloop);
            }
            gameloop = setInterval(advanceField, 50+((maxLevel-level)*100));
        }
        setGameLoop();
    </script>
</head>
<body>
    <div class="container">
        <div class="game" id="game">
            <div class="level">Level: <span id="level">1</span></div>
            <div class="score">Score: <span id="score">0</span></div>
            <div class="field">
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        resizeGame();
        restartGame(true);
    </script>
</body>
</html>